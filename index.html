<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Imtihon Platformasi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; margin: 0; padding: 15px; color: #333; }
        
        /* Kartochka dizayni */
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h3 { color: #0088cc; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 14px; color: #555; }
        
        input, select { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input:focus, select:focus { border-color: #0088cc; background: #fff; outline: none; }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* Savollar panjarasi (2 ustunli) */
        .q-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* Ikki ustun */
            gap: 12px; 
        }

        .q-card { 
            background: white; 
            padding: 12px; 
            border-radius: 12px; 
            border: 1px solid #eee;
            position: relative;
        }

        .q-num { font-weight: bold; color: #0088cc; margin-bottom: 8px; display: block; }
        
        /* Javob variantlari (A, B, C, D) */
        .options { display: flex; justify-content: space-between; }
        .radio-label { 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 12px; 
            font-weight: bold;
            color: #666;
        }
        .radio-label input { margin-bottom: 3px; width: 18px; height: 18px; cursor: pointer; }

        /* Tugma */
        .btn { 
            width: 100%; padding: 16px; 
            background: linear-gradient(135deg, #28a745, #218838); 
            color: white; border: none; border-radius: 12px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            margin-top: 20px; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }
        .btn:active { transform: scale(0.98); }
        .loading { opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>

<div class="card">
    <h3>‚öôÔ∏è Test Sozlamalari</h3>
    
    <label>Ism va Familiya:</label>
    <input type="text" id="fullname" placeholder="Ismingizni to'liq yozing">
    
    <label>Test kodi:</label>
    <input type="text" id="testCode" placeholder="O'qituvchi bergan kod (masalan: 123)">

    <label>Fan:</label>
    <select id="subject">
        <option value="Matematika">Matematika</option>
        <option value="Ona tili">Ona tili</option>
        <option value="Tarix">Tarix</option>
        <option value="Ingliz tili">Ingliz tili</option>
        <option value="Biologiya">Biologiya</option>
        <option value="Kimyo">Kimyo</option>
        <option value="Fizika">Fizika</option>
        <option value="Huquq">Huquq</option>
        <option value="IQ">IQ (Mantiq)</option>
        <option value="Boshqa">Boshqa fanlar</option>
    </select>

    <div class="settings-grid">
        <div>
            <label>Savollar:</label>
            <input type="number" id="qCount" value="30" min="1" max="150">
        </div>
        <div>
            <label>Baholash:</label>
            <select id="gradingFormat">
                <option value="standard">Oddiy (1 ball)</option>
                <option value="dtm">DTM (Blok)</option>
            </select>
        </div>
    </div>
</div>

<div id="quizForm" class="q-container"></div>

<button type="button" id="submitBtn" class="btn" onclick="submitTest()">Natijani Yuborish üöÄ</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // ---------------------------------------------------------
    // ‚ö†Ô∏è SUPABASE SOZLAMALARI (TO'G'RILANDI)
    // ---------------------------------------------------------
    // URLingizni to'liq formatda yozdim. Agar ishlamasa, project settingsdan to'lig'ini oling.
    const SUPABASE_URL = 'https://hjwjomkywxnijfxnrwdt.supabase.co'; 
    const SUPABASE_KEY = 'SIZNING_ANON_KEY_SHU_YERGA'; // ‚ö†Ô∏è Bu yerga o'sha uzun ANON KEYni qo'ying!
    // ---------------------------------------------------------

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const qContainer = document.getElementById('quizForm');
    const qCountInput = document.getElementById('qCount');

    // Dastlabki yuklanishda savollarni chiqarish
    generateQuestions();

    // Input o'zgarganda savollarni yangilash
    qCountInput.addEventListener('input', generateQuestions);

    function generateQuestions() {
        const count = parseInt(qCountInput.value);
        qContainer.innerHTML = ''; // Tozalash

        if (isNaN(count) || count < 1) return;

        for (let i = 1; i <= count; i++) {
            const div = document.createElement('div');
            div.className = 'q-card';
            div.innerHTML = `
                <span class="q-num">${i}-savol</span>
                <div class="options">
                    <label class="radio-label"><input type="radio" name="q${i}" value="A">A</label>
                    <label class="radio-label"><input type="radio" name="q${i}" value="B">B</label>
                    <label class="radio-label"><input type="radio" name="q${i}" value="C">C</label>
                    <label class="radio-label"><input type="radio" name="q${i}" value="D">D</label>
                </div>
            `;
            qContainer.appendChild(div);
        }
    }

    async function submitTest() {
        const btn = document.getElementById('submitBtn');
        const name = document.getElementById('fullname').value.trim();
        const code = document.getElementById('testCode').value.trim();
        const count = parseInt(qCountInput.value);
        const format = document.getElementById('gradingFormat').value;
        const subject = document.getElementById('subject').value;
        const userId = tg.initDataUnsafe?.user?.id || 0; // Telegram ID

        if (!name || !code) {
            tg.showAlert("Iltimos, Ism va Test kodini kiriting!");
            return;
        }

        btn.innerText = "Yuborilmoqda...";
        btn.classList.add('loading');

        try {
            // 1. Bazadan test kalitlarini olish
            const { data: testData, error: fetchError } = await supabase
                .from('tests')
                .select('*')
                .eq('code', code)
                .single();

            if (fetchError || !testData) {
                throw new Error("Bunday kodli test topilmadi yoki o'chirilgan!");
            }

            if (!testData.is_active) {
                throw new Error("Bu test yakunlangan!");
            }

            // 2. Javoblarni yig'ish va ballni hisoblash
            let correctKeys = testData.answers.toUpperCase(); // Masalan: "ABCD..."
            let score = 0;
            let wrongIndexes = [];
            
            // O'quvchi javoblarini yig'ish
            for (let i = 1; i <= count; i++) {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                const userVal = selected ? selected.value : null;
                const correctVal = correctKeys[i-1] ? correctKeys[i-1] : null; // Bazadagi to'g'ri javob

                // Ball hisoblash mantiqi
                let points = 0;
                
                if (userVal && userVal === correctVal) {
                    if (format === 'dtm') {
                        if (i <= 30) points = 1.1;
                        else if (i <= 60) points = 2.1;
                        else points = 3.1;
                    } else {
                        points = 1; // Standart
                    }
                } else {
                    wrongIndexes.push(i); // Xato savol raqami
                }
                score += points;
            }

            // Ballni yaxlitlash
            score = Math.round(score * 10) / 10;

            // 3. Natijani Supabase-ga yuborish
            const { error: insertError } = await supabase
                .from('results')
                .insert([{
                    user_id: userId,
                    user_name: name,
                    test_code: code,
                    score: score,
                    wrong_answers: wrongIndexes.join(', '),
                    finished_at: new Date()
                }]);

            if (insertError) throw insertError;

            // 4. Muvaffaqiyatli yakun
            tg.showAlert(`‚úÖ Natija yuborildi!\nSizning ballingiz: ${score}`);
            tg.close();

        } catch (err) {
            tg.showAlert("Xatolik: " + err.message);
            btn.innerText = "Qayta urinish";
            btn.classList.remove('loading');
        }
    }
</script>

</body>
</html>
